<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Ansible Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Socket.IO client from CDN -->
  <!-- <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js" integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Ansible Live Events</h1>
      <div id="status" class="text-sm px-2 py-1 rounded bg-slate-200">disconnected</div>
    </header>

    <!-- Job selector -->
    <section class="bg-white rounded-2xl shadow p-4">
      <form id="joinForm" class="flex flex-col gap-3 sm:flex-row sm:items-end">
        <label class="flex-1">
          <span class="block text-sm text-slate-600 mb-1">Job ID</span>
          <input id="jobIdInput" type="text" placeholder="e.g., 5c0e3b9a-..." class="w-full rounded-xl border border-slate-300 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
        </label>
        <button type="submit" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 transition">Join</button>
        <button id="clearBtn" type="button" class="rounded-xl px-4 py-2 border border-slate-300 hover:bg-slate-100">Clear</button>
      </form>
      <p class="mt-2 text-sm text-slate-500">Tip: add <code>?jobId=&lt;uuid&gt;</code> to the URL to auto-join.</p>
    </section>

    <!-- Stream -->
    <section class="bg-white rounded-2xl shadow p-0 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
        <div class="font-medium">Event Stream</div>
        <label class="flex items-center gap-2 text-sm text-slate-600">
          <input id="autoscroll" type="checkbox" class="rounded" checked />
          Auto-scroll
        </label>
      </div>
      <div id="log" class="h-[60vh] overflow-auto p-4 space-y-2 font-mono text-sm bg-slate-50"></div>
    </section>
  </div>

  <script>
    // --- helpers ---
    function qs(k) {
      return new URL(window.location.href).searchParams.get(k);
    }
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const jobInput = document.getElementById('jobIdInput');
    const joinForm = document.getElementById('joinForm');
    const clearBtn = document.getElementById('clearBtn');
    const autoscrollEl = document.getElementById('autoscroll');

    // --- socket setup ---
    // Your Nest server is at 127.0.0.1:3000. Namespace is /ansible.
    const socket = io('http://127.0.0.1:3000/ansible', {
      transports: ['websocket', 'polling'],
      withCredentials: false,
      // path: '/socket.io', // default; uncomment if you changed it server-side
    });

    socket.on('connect', () => setStatus('connected', 'bg-green-100'));
    socket.on('disconnect', () => setStatus('disconnected', 'bg-slate-200'));
    socket.on('connect_error', (err) => setStatus(`error: ${err.message}`, 'bg-rose-100'));

    // Expect structured events from your Nest gateway/service
    socket.on('ansible:event', (evt) => {
      appendEvent(evt);
    });

    // simple join room message (make sure your gateway implements @SubscribeMessage('join'))
    function joinJob(jobId) {
      if (!jobId) return;
      socket.emit('join', {
        room: jobId
      });
      banner(`Joined job ${jobId}`);
    }

    // UI wiring
    joinForm.addEventListener('submit', (e) => {
      e.preventDefault();
      joinJob(jobInput.value.trim());
    });
    clearBtn.addEventListener('click', () => {
      logEl.innerHTML = '';
    });

    // auto-join if ?jobId=...
    const initialJob = qs('jobId');
    if (initialJob) {
      jobInput.value = initialJob;
      const tryJoin = () => {
        if (socket.connected) joinJob(initialJob);
        else setTimeout(tryJoin, 100);
      };
      tryJoin();
    }

    // --- rendering ---
    function setStatus(text, klass) {
      statusEl.textContent = text;
      statusEl.className = `text-sm px-2 py-1 rounded ${klass}`;
    }

    function banner(text) {
      const row = document.createElement('div');
      row.className = 'px-3 py-2 bg-indigo-50 text-indigo-900 rounded-xl';
      row.textContent = text;
      logEl.appendChild(row);
      maybeScroll();
    }

    function badge(label, color) {
      const el = document.createElement('span');
      el.className = `text-[11px] px-2 py-0.5 rounded-full border ${color}`;
      el.textContent = label;
      return el;
    }

    function line(text, subtle = false) {
      const el = document.createElement('pre');
      el.className = `whitespace-pre-wrap break-words ${subtle ? 'text-slate-500' : ''}`;
      el.textContent = text;
      return el;
    }

    function rowWrap(...children) {
      const row = document.createElement('div');
      row.className = 'flex items-start gap-3 bg-white border border-slate-200 rounded-xl px-3 py-2';
      children.forEach(c => row.appendChild(c));
      return row;
    }

    function appendEvent(evt) {
      const ts = evt.time || new Date().toISOString();
      let b, content;

      switch (evt.type) {
        case 'play-start':
          b = badge('PLAY', 'border-amber-300 bg-amber-50 text-amber-900');
          content = line(`[${ts}] ${evt.play}`);
          break;
        case 'task-start':
          b = badge('TASK', 'border-sky-300 bg-sky-50 text-sky-900');
          content = line(`[${ts}] ${evt.task}`);
          break;
        case 'host-result': {
          const colorMap = {
            ok: 'border-emerald-300 bg-emerald-50 text-emerald-900',
            changed: 'border-indigo-300 bg-indigo-50 text-indigo-900',
            failed: 'border-rose-300 bg-rose-50 text-rose-900',
            skipped: 'border-slate-300 bg-slate-50 text-slate-900',
            unreachable: 'border-orange-300 bg-orange-50 text-orange-900',
          };
          b = badge(evt.status.toUpperCase(), colorMap[evt.status] || 'border-slate-300');
          content = line(`[${ts}] ${evt.host}${evt.summary ? ' ' + evt.summary : ''}`);
          break;
        }
        case 'stdout':
          b = badge('OUT', 'border-slate-300 bg-slate-50 text-slate-900');
          content = line(`[${ts}] ${evt.line}`);
          break;
        case 'stderr':
          b = badge('ERR', 'border-rose-300 bg-rose-50 text-rose-900');
          content = line(`[${ts}] ${evt.line}`);
          break;
        case 'exit':
          b = badge('EXIT', evt.code === 0 ? 'border-emerald-300 bg-emerald-50 text-emerald-900' : 'border-rose-300 bg-rose-50 text-rose-900');
          content = line(`[${ts}] code=${evt.code} signal=${evt.signal}`, true);
          break;
        default:
          b = badge('EVENT', 'border-slate-300 bg-slate-50 text-slate-900');
          content = line(`[${ts}] ${JSON.stringify(evt)}`);
      }

      const row = rowWrap(b, content);
      logEl.appendChild(row);
      maybeScroll();
    }

    function maybeScroll() {
      if (!autoscrollEl.checked) return;
      logEl.scrollTop = logEl.scrollHeight;
    }
  </script>
</body>

</html>